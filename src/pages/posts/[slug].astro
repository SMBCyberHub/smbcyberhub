---
import Layout from '../../layouts/Layout.astro';
import RelatedPosts from '../../components/RelatedPosts.astro';
import { getCollection, getEntryBySlug } from 'astro:content';
import { AstroError } from 'astro/errors';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { slug: post.slug },
  }));
}

const SITE = 'https://smbcyberhub.com';
const { slug } = Astro.props;
const post = await getEntryBySlug('posts', slug);

if (!post) {
  throw new AstroError(`No post found for slug: ${slug}`);
}

const { Content } = await post.render();
const { data } = post;

// --- Helpers for safe schema values ---
const canonicalUrl = `${SITE}/posts/${slug}/`;
const isoDate = new Date(data.date).toISOString();
const isoModified = data.dateModified ? new Date(data.dateModified).toISOString() : isoDate;
const ogImageUrl =
  typeof data.ogImage === 'string' && data.ogImage.startsWith('http')
    ? data.ogImage
    : `${SITE}${data.ogImage || '/images/smbcyberhub-logo.webp'}`;
const clean = (s) => String(s || '').replace(/\s+/g, ' ').trim();

// --- BlogPosting schema object (no undefineds, no trailing commas) ---
const articleSchema = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: clean(data.title),
  description: clean(data.description || data.excerpt),
  image: [ogImageUrl],                 // array is fine/preferred by Google
  url: canonicalUrl,                   // optional but nice to have
  author: {
    '@type': 'Person',
    name: 'Jim SMBCyberHub',
    jobTitle: 'Cybersecurity Compliance Specialist',
    url: `${SITE}/about/`,
    sameAs: [
      'https://www.linkedin.com/in/smb-cyberhub-67567b374/',
      'https://x.com/SMBCyberHub'
    ]
  },
  publisher: {
    '@type': 'Organization',
    name: 'SMBCyberHub',
    url: SITE,                         // optional, improves completeness
    logo: { '@type': 'ImageObject', url: `${SITE}/images/smbcyberhub-logo.webp` }
  },
  datePublished: isoDate,
  dateModified: isoModified,
  mainEntityOfPage: canonicalUrl,
  speakable: {
    '@type': 'SpeakableSpecification',
    cssSelector: ['article h1', 'article .prose p:first-of-type']
  }
};


// --- BreadcrumbList schema ---
const breadcrumbSchema = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    { '@type': 'ListItem', position: 1, name: 'Home', item: SITE },
    { '@type': 'ListItem', position: 2, name: 'Blog', item: `${SITE}/blog/` },
    { '@type': 'ListItem', position: 3, name: clean(data.title), item: canonicalUrl }
  ]
};
---

<Layout
  title={`${data.title} | SMBCyberHub`}
  description={data.description}
  ogImage={ogImageUrl}
  ogType="article"
  canonical={canonicalUrl}
  publishedTime={isoDate}
  tags={data.tags || []}
>
  <script type="application/ld+json" set:html={JSON.stringify(articleSchema)}></script>
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)}></script>
  <article class="py-16 px-6 max-w-3xl mx-auto">
    <!-- Breadcrumbs -->
    <nav class="mb-6" aria-label="Breadcrumb">
      <ol class="flex items-center space-x-2 text-sm text-gray-600">
        <li><a href="/" class="hover:text-blue-600">Home</a></li>
        <li><span class="mx-2">/</span></li>
        <li><a href="/blog/" class="hover:text-blue-600">Blog</a></li>
        <li><span class="mx-2">/</span></li>
        <li class="text-gray-900 font-medium">{data.title}</li>
      </ol>
    </nav>
    
    <h1 class="text-4xl font-bold text-blue-900 mb-4">{data.title}</h1>
    <p class="text-sm text-gray-500 mb-6">
      {new Date(data.date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' })}
    </p>
    <div class="prose prose-lg text-gray-800">
      <Content />
    </div>
    
    <RelatedPosts currentSlug={slug} tags={data.tags || []} />

    <!-- Contextual CTA based on tags -->
    {(() => {
      const tags = data.tags || [];
      let ctaTitle = "üìã The 30-Minute Audit-Ready Framework";
      let ctaDescription = "Download SMBCyberHub's compliance kits ‚Äî GDPR-aligned training, policies, and checklists. No subscriptions, no logins, instant access.";
      let primaryCTA = "üì• Try Free Sample";
      
      if (tags.includes('phishing')) {
        ctaTitle = "üé£ Complete Phishing Protection Kit";
        ctaDescription = "Get our phishing awareness training slides, staff quizzes, and prevention checklists. Everything you need to protect your team from email attacks.";
        primaryCTA = "üì• Get Phishing Training Kit";
      } else if (tags.includes('gdpr') || tags.includes('compliance')) {
        ctaTitle = "üìã GDPR Compliance Documentation Kit";
        ctaDescription = "Download GDPR-aligned policy templates, staff training records, and audit checklists. Pass your compliance audit with confidence.";
        primaryCTA = "üì• Get GDPR Compliance Kit";
      } else if (tags.includes('cyber insurance')) {
        ctaTitle = "üõ°Ô∏è Cyber Insurance Documentation Kit";
        ctaDescription = "Get everything insurers expect to see: training records, policies, incident response plans, and audit documentation.";
        primaryCTA = "üì• Get Insurance Documentation Kit";
      } else if (tags.includes('mfa') || tags.includes('password')) {
        ctaTitle = "üîê Security Awareness Training Kit";
        ctaDescription = "Complete security awareness training covering passwords, MFA, and device security. Perfect for insurance compliance.";
        primaryCTA = "üì• Get Security Training Kit";
      } else if (tags.includes('offboarding') || tags.includes('access control')) {
        ctaTitle = "üë• Access Management Templates Kit";
        ctaDescription = "Professional templates for onboarding, offboarding, and access reviews. Audit-ready documentation for compliance.";
        primaryCTA = "üì• Get Access Management Kit";
      }
      
      return (
        <div class="mt-12 p-6 bg-gradient-to-r from-blue-50 to-emerald-50 rounded-xl border border-blue-200">
          <h3 class="text-xl font-bold text-gray-900 mb-3">{ctaTitle}</h3>
          <p class="text-gray-700 mb-6">{ctaDescription}</p>
          <div class="flex flex-col sm:flex-row gap-4">
            <a href="/free-cyber-security-training/" class="inline-flex items-center justify-center px-6 py-3 bg-emerald-600 text-white font-medium rounded-lg hover:bg-emerald-700 transition">
              {primaryCTA}
            </a>
            <a href="/kits/" class="inline-flex items-center justify-center px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition">
              üß∞ Compare All Kits
            </a>
          </div>
        </div>
      );
    })()}
  </article>
</Layout>
